(function(h){h.extend(h.fn.bootstrapTable.defaults,{clickEdit:false});function d(t,n,m){var q=m.data().index;var o=get(n.$el);if(typeof o.curEditRowId!="undefined"&&q!=o.curEditRowId){if(n.$body.find("tr:eq("+o.curEditRowId+")").hasClass("editing")){o.endEdit()}else{o.editing=true;o.curEditRowId=undefined;o.editRow=undefined}}if(o.editing){event.stopPropagation();if(t.editable==false){return}m.addClass("editing");o.editing=false;o.curEditRowId=q;o.editRow=t;var k=new h.pageProxy(m,o.options.pageProxy);k.hasParsed=false;n.columns.each(function(u,v){if(v.editable&&v.editType=="select"){v.editOptions.pageProxy=k;if(v.editOptions._cascadeId){n.columns.each(function(x,w){if(w.field==v.editOptions._cascadeId){v.cascadeUrl=w.editOptions.dataUrl||v.cascadeUrl;w.editOptions.dataUrl=null;w.editOptions.cascadeReadonly=true}})}}});m.find("div.cell").each(function(){var v=h(this);var u=v.data("field");if(u){n.columns.each(function(w,x){if(x.field==u){if(x.editable){if(x.onBeforeEdit){var y=o.exec(x.onBeforeEdit,[q,t,x.field]);if(y===false){return false}}c(v,x,t[x.field],o)}return false}})}});n.columns.each(function(u,v){if(v.editable&&v.editType=="select"){if(v.editOptions._cascadeId){var w=get(h("[field='"+v.field+"']",m));w.cascadeUrl=v.cascadeUrl;w.$cascadeTarget=h("[field='"+v.editOptions._cascadeId+"']",m)}}});k.hasParsed=false;k.execPageReady();if(o.options.editColumnBtn){var p='<a class="button-column editable-submit" href="javascript:;"><span>确定</span></a>',s='<a class="button-column editable-delete" href="javascript:;"><span>删除</span></a>';var r=createTag("").append(p);if(o.options.deleteEditBtn){r.append('<i class="btn-linked-split"></i>').append(s)}if(o.options.sortBtn){if(o.curEditRowId>0){var l='<a class="button-column editable-moveUp" href="javascript:;"><span>↑</span></a>';r.append('<i class="btn-linked-split"></i>').append(l)}if(o.curEditRowId<o.getRows().length-1){var i='<a class="button-column editable-moveDown" href="javascript:;"><span>↓</span></a>';r.append('<i class="btn-linked-split"></i>').append(i)}}m.find("td").last().addClass("edit-buttons").html(r.toString());m.find(".editable-submit").on("click",function(){o.endEdit();return false});m.find(".editable-delete").on("click",function(){o.deleteRow(o.curEditRowId);o.editing=true;o.curEditRowId=undefined;o.editRow=undefined;return false});m.find(".editable-moveUp").on("click",function(){o.moveUpRow(o.curEditRowId);return false});m.find(".editable-moveDown").on("click",function(){o.moveDownRow(o.curEditRowId);return false})}var j=h(event.target).find(".grid-input:first");if(j.length==0){j=m.find(".grid-input:first")}get(j).focus()}}function b(m,o,i,k,j){var l=i.find("[data-field="+k+"]");var n=i.data().index;if(typeof j.curEditRowId!="undefined"&&!l.hasClass("editable-input")){h(document).trigger("click.gridEdit")}if(j.editing){o.columns.each(function(p,q){if(q.field==k){if(q.editable){if(q.onBeforeEdit){var r=j.exec(q.onBeforeEdit,[n,m,q.field]);if(r===false){return false}}c(l,q,m[q.field],j);i.addClass("editing");l.parent().addClass("editing");var s=l.find(".grid-input.form-item");if(s.length){get(s).focus();event.stopPropagation()}j.editing=false;j.curEditRowId=n;j.editRow=m}return false}})}}function c(m,j,l,k){m.removeAttr("title");var i=j.editType;var n=h(createTag("div").attr("field",j.field).addClass("grid-input form-item").toString());m.addClass("editable-input").html(n);j.editOptions.value=l;if(j.editType=="textInput"&&j.editOptions.multiple){n.textarea(j.editOptions)}else{n[i](j.editOptions)}get(n).$table=k;l!=null&&get(n).validate()}function g(p){function o(u,s){var w=u.data("field");var x=u.closest("tr").index();var v=m.getRows();var q;for(var r=0;r<i;r++){var t=s[r];if(t.field==w){q=r}}return{rowIndex:x,rows:v,colIndex:q}}function j(r,q){var s=get(r.find(".grid-input"));switch(q){case"textInput":case"numberInput":s.$input.change();break;case"select":s.$select.select2("close");break;case"datetime":s.$dateInp.datepicker("hide");if(s.$timeInp){s.$timeInp.blur();s.$timeCombobox.detach()}break;case"area":s.hideDropdown();break;default:break}s.getTooltipTarget().tooltip("hide")}function n(q,x,r,s,v){j(q,r.editType);q.closest("tr.editing").removeClass("editing");var u=get(q.find(".grid-input"));p.updateCell({index:q.closest("tr").index(),field:q.data("field"),value:u.getValue()});var t=p.$body.find("tr:eq("+x+") [data-field='"+s.field+"']").closest("div.cell");c(t,s,v[s.field],m);t.closest("tr").addClass("editing");t.closest("td").addClass("editing");var w=t.find(".grid-input.form-item");if(w.length){get(w).focus()}m.editing=false;m.curEditRowId=x;m.editRow=v;var u=get(t.find(".grid-input"));if("area"==s.editType){u.$select.on("keyup",function(){u.showDropdown()})}}var m=get(p.$el);var l={tab:9,enter:13,left:37,up:38,right:39,down:40};var k=[];p.columns.each(function(q,r){if(!r.hidden&&r.editable&&r.isShortcutKey){k.push(r)}});var i=k.length;p.$el.off("keydown.shortcutKey").on("keydown.shortcutKey",".editable-input",function(v){var s=v.which;switch(s){case l.enter:case l.down:var u=o(h(this),k);if(typeof u.colIndex=="undefined"){return}v.preventDefault();var r;var t=false;while(!t){u.rowIndex++;if(u.rowIndex>=u.rows.length){return}t=true;r=k[u.colIndex];if(r.onBeforeEdit){t=m.exec(r.onBeforeEdit,[u.rowIndex,u.rows[u.rowIndex],r.field])!==false}}n(h(this),u.rowIndex,r,r,u.rows[u.rowIndex]);break;case l.up:var u=o(h(this),k);if(typeof u.colIndex=="undefined"){return}v.preventDefault();var r;var t=false;while(!t){u.rowIndex--;if(u.rowIndex<0){return}t=true;r=k[u.colIndex];if(r.onBeforeEdit){t=m.exec(r.onBeforeEdit,[u.rowIndex,u.rows[u.rowIndex],r.field])!==false}}n(h(this),u.rowIndex,r,r,u.rows[u.rowIndex]);break;case l.left:var u=o(h(this),k);if(typeof u.colIndex=="undefined"){return}v.preventDefault();var r;var t=false;var q;var w=0;while(!t){w++;q=(u.colIndex-w)%i;if(q<0){q+=i}u.rowIndex+=(u.colIndex-w-q)/i;if(u.rowIndex<0){return}t=true;r=k[q];if(r.onBeforeEdit){t=m.exec(r.onBeforeEdit,[u.rowIndex,u.rows[u.rowIndex],r.field])!==false}}n(h(this),u.rowIndex,k[u.colIndex],r,u.rows[u.rowIndex]);break;case l.tab:case l.right:var u=o(h(this),k);if(typeof u.colIndex=="undefined"){return}v.preventDefault();var r;var t=false;var q;var w=0;while(!t){w++;q=(u.colIndex+w)%i;u.rowIndex+=(u.colIndex+w-q)/i;if(u.rowIndex>=u.rows.length){return}t=true;r=k[q];if(r.onBeforeEdit){t=m.exec(r.onBeforeEdit,[u.rowIndex,u.rows[u.rowIndex],r.field])!==false}}n(h(this),u.rowIndex,k[u.colIndex],r,u.rows[u.rowIndex]);break;default:break}})}var a=h.fn.bootstrapTable.Constructor,f=a.prototype.initTable,e=a.prototype.initBody;a.prototype.initTable=function(){var i=this;this.$data={};f.apply(this,Array.prototype.slice.apply(arguments));if(!this.options.clickEdit){return}};a.prototype.initBody=function(){e.apply(this,Array.prototype.slice.apply(arguments));if(!this.options.clickEdit){return}var j=this.$tableBody.find("table");var i=get(this.$el);i.editing=true;j.off("click-row.bs.table").on("click-row.bs.table",function(o,p,l,n){if(l&&l.prevObject&&l.prevObject.hasClass("operate-btn")){return false}if(!i.options.edit){return false}var m=i.options.onBeforeEdit;if(m){var k=i.exec(m,[p,p.sort_index]);if(k==false){return false}}if(i.options.editType=="cell"){b(p,this,l,n,i)}else{d(p,this,l)}return false}.bind(this));var i=get(this.$el);if(i.options.editType=="cell"){g(this)}};a.prototype.updateCell=function(A){if(!A.hasOwnProperty("index")||!A.hasOwnProperty("field")||!A.hasOwnProperty("value")){return}this.data[A.index][A.field]=A.value;var o=this;var t=null;for(var u=0;u<this.header.fields.length;u++){if(this.header.fields[u]==A.field){t=u;break}}var q="",r=A.value,s="",n="",z={},v=[],k="",B=o.header.classes[t],p="",l=o.columns[t],x=o.options.data[A.index],y=h.fn.bootstrapTable.utils;if(!l.visible){return}if(l.escape){r=y.escapeHTML(r)}var w=y.calculateObjectValue(this.options,this.options.rowStyle,[x,A.index],w);if(w&&w.css){for(C in w.css){v.push(C+": "+w.css[C])}}w=sprintf('style="%s"',v.concat(o.header.styles[t]).join("; "));z=y.calculateObjectValue(o.header,o.header.cellStyles[t],[r,x,A.index,A.field],z);if(z.classes){B=sprintf(' class="%s"',z.classes)}if(z.css){var m=[];for(var C in z.css){m.push(C+": "+z.css[C])}w=sprintf('style="%s"',m.concat(o.header.styles[t]).join("; "))}s=y.calculateObjectValue(l,o.header.formatters[t],[r,x,A.index,A.field],r);if(!l.wrapText&&typeof s=="string"&&s.indexOf("<")==-1){p=sprintf(' title="%s"',s)}s=typeof s==="undefined"||s===null?o.options.undefinedText:s;q=[sprintf("<td%s %s %s %s>",k,B,w,p),sprintf('<div class="cell grid-cell-%s-%s %s" data-field="%s">',o.index,A.field,l.wrapText?"":"nowrap",A.field),s,"</div>","</td>"].join("");this.$body.find("tr:eq("+A.index+") > td > [data-field='"+A.field+"']").parent().replaceWith(q)};h(document).off("click.gridEdit").on("click.gridEdit",function(k){var j=h("tr.editing");if(j.length){var i=j.parents("table");i.each(function(){var n=get(h(this));if(n.options.editType=="cell"){var r=n.curEditRowId;if(typeof r!="undefined"){var m=i.find("tbody tr:eq("+(r)+")");if(m){var l=h(k.target);if(l.closest(".time-combobox, .select2-container, .area-select-dropdown").length){return}if(n.options.editType=="cell"){var q=(l.closest("td.editing").length>0);if(!q){var p=n.$elem.find(".editable-input").data("field");if(p){get(m.find(".editable-input > .form-item")).disableValidation();var o=n.editRow[p];n.bootstrapTable.updateCell({index:r,field:p,value:o});j.removeClass("editing");n.editing=true;n.curEditRowId=undefined;n.editRow=undefined;n.exec(n.opts.onChange)}}}}}}})}})})(jQuery);